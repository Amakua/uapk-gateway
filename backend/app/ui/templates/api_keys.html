{% extends "base.html" %}

{% block content %}
<h1>API Keys</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="font-size: 1.125rem; margin: 0;">Your API Keys</h2>
        <button class="btn-primary" onclick="showCreateModal()">Create API Key</button>
    </div>

    {% if api_keys %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 1px solid var(--border);">
                <th style="text-align: left; padding: 0.75rem 0; color: var(--text-muted); font-weight: 500;">Name</th>
                <th style="text-align: left; padding: 0.75rem 0; color: var(--text-muted); font-weight: 500;">Key Prefix</th>
                <th style="text-align: left; padding: 0.75rem 0; color: var(--text-muted); font-weight: 500;">Status</th>
                <th style="text-align: left; padding: 0.75rem 0; color: var(--text-muted); font-weight: 500;">Created</th>
                <th style="text-align: left; padding: 0.75rem 0; color: var(--text-muted); font-weight: 500;">Last Used</th>
                <th style="text-align: right; padding: 0.75rem 0; color: var(--text-muted); font-weight: 500;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for key in api_keys %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.75rem 0;">{{ key.name }}</td>
                <td style="padding: 0.75rem 0;"><code style="background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ key.key_prefix }}...</code></td>
                <td style="padding: 0.75rem 0;">
                    {% if key.status.value == 'active' %}
                    <span class="status-badge status-ok">Active</span>
                    {% else %}
                    <span class="status-badge status-error">Revoked</span>
                    {% endif %}
                </td>
                <td style="padding: 0.75rem 0;">{{ key.created_at.strftime('%Y-%m-%d') }}</td>
                <td style="padding: 0.75rem 0;">{{ key.last_used_at.strftime('%Y-%m-%d %H:%M') if key.last_used_at else 'Never' }}</td>
                <td style="padding: 0.75rem 0; text-align: right;">
                    {% if key.status.value == 'active' %}
                    <button class="btn-danger-small" onclick="revokeKey('{{ key.id }}')">Revoke</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="placeholder">
        <p>No API keys yet. Create one to get started.</p>
    </div>
    {% endif %}
</div>

<!-- Create API Key Modal -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: var(--card-bg); border-radius: 8px; padding: 1.5rem; max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 1rem;">Create API Key</h3>
        <form id="createForm">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name</label>
                <input type="text" id="keyName" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Organization</label>
                <select id="keyOrg" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                    {% if user_with_orgs %}
                    {% for org in user_with_orgs.organizations %}
                    <option value="{{ org.org_id }}">{{ org.org_name }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" class="btn-secondary" onclick="hideCreateModal()">Cancel</button>
                <button type="submit" class="btn-primary">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Show Key Modal -->
<div id="showKeyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: var(--card-bg); border-radius: 8px; padding: 1.5rem; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1rem;">API Key Created</h3>
        <p style="margin-bottom: 1rem; color: var(--text-muted);">Copy this key now. You won't be able to see it again!</p>
        <div style="background: var(--bg); padding: 1rem; border-radius: 4px; margin-bottom: 1rem; word-break: break-all;">
            <code id="newKeyValue"></code>
        </div>
        <button class="btn-primary" onclick="copyKey()">Copy to Clipboard</button>
        <button class="btn-secondary" onclick="hideShowKeyModal()">Done</button>
    </div>
</div>

<style>
    .btn-primary {
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-primary:hover {
        background: var(--primary-dark);
    }
    .btn-secondary {
        padding: 0.5rem 1rem;
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-danger-small {
        padding: 0.25rem 0.5rem;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
    }
</style>

<script>
    function showCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }
    function hideCreateModal() {
        document.getElementById('createModal').style.display = 'none';
    }
    function showShowKeyModal(key) {
        document.getElementById('newKeyValue').textContent = key;
        document.getElementById('showKeyModal').style.display = 'flex';
    }
    function hideShowKeyModal() {
        document.getElementById('showKeyModal').style.display = 'none';
        location.reload();
    }
    function copyKey() {
        const key = document.getElementById('newKeyValue').textContent;
        navigator.clipboard.writeText(key);
    }

    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('keyName').value;
        const org_id = document.getElementById('keyOrg').value;

        // Get token from cookie
        const token = document.cookie.split('; ').find(row => row.startsWith('access_token='))?.split('=')[1];

        try {
            const response = await fetch('/api/v1/api-keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, org_id })
            });

            if (response.ok) {
                const data = await response.json();
                hideCreateModal();
                showShowKeyModal(data.key);
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create API key'));
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });

    async function revokeKey(keyId) {
        if (!confirm('Are you sure you want to revoke this API key? This cannot be undone.')) {
            return;
        }

        const token = document.cookie.split('; ').find(row => row.startsWith('access_token='))?.split('=')[1];

        try {
            const response = await fetch(`/api/v1/api-keys/${keyId}/revoke`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to revoke API key'));
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }
</script>
{% endblock %}
